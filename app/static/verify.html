<!doctype html>
<html>

<head>
    <title>Verify</title>
</head>

<body>
    <h2>Verification Page</h2>
    <div id="info"></div>
    <div id="loginArea">
        <h3>Login</h3>
        <input id="email" placeholder="email"><br>
        <input id="password" placeholder="password" type="password"><br>
        <button onclick="login()">Login</button>
    </div>
    <div id="docsArea" style="display:none;">
        <h3>Your Documents</h3>
        <div id="docsList"></div>
    </div>

    <script>
        const token = "{{TOKEN}}";
        async function login() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const fd = new URLSearchParams();
            fd.append("username", email);
            fd.append("password", password);
            const res = await fetch("/api/auth/login", { method: "POST", body: fd });
            if (!res.ok) { alert("Login failed"); return; }
            const d = await res.json();
            localStorage.setItem("token", d.access_token);
            document.getElementById("loginArea").style.display = "none";
            loadVerify();
        }

        async function loadVerify() {
            const res = await fetch("/api/verify/" + token);
            if (!res.ok) { document.getElementById("info").innerText = "Invalid token"; return; }
            const meta = await res.json();
            document.getElementById("info").innerText = "Requested: " + JSON.stringify(meta.requested_fields);
            // fetch user's docs
            const hdr = { "Authorization": "Bearer " + localStorage.getItem("token") };
            const docsRes = await fetch("/api/documents", { headers: hdr });
            const docs = await docsRes.json();
            const list = document.getElementById("docsList");
            list.innerHTML = "";
            docs.forEach(d => {
                const el = document.createElement("div");
                el.innerHTML = `${d.id} - ${d.doc_type} - ${d.filename} <button onclick="share(${d.id})">Share</button>`;
                list.appendChild(el);
            });
            document.getElementById("docsArea").style.display = "block";
        }

        async function share(doc_id) {
            const fd = new FormData();
            fd.append("doc_id", doc_id);
            const hdr = { "Authorization": "Bearer " + localStorage.getItem("token") };
            const res = await fetch("/api/verify/" + token + "/share", { method: "POST", headers: hdr, body: fd });
            const j = await res.json();
            alert("Shared. Verifier download link: " + j.download_link);
        }
    </script>
</body>

</html>