<!doctype html>
<html>

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SecureDocs — Mobile Upload</title>
    <style>
        body {
            font-family: Inter, system-ui, Arial;
            background: #fff;
            padding: 12px;
            color: #111827
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        h2 {
            margin: 6px 0
        }

        .muted {
            color: #6b7280
        }

        .card {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #f1f5f9;
            margin-top: 10px
        }

        .btn {
            background: #0b69ff;
            color: white;
            padding: 10px;
            border-radius: 8px;
            border: none
        }

        input[type=file] {
            display: block;
            margin-top: 8px
        }
    </style>
</head>

<body>
    <div class="header">
        <h2>Upload documents</h2>
        <div class="muted">SecureDocs</div>
    </div>
    <p id="info" class="muted">Loading...</p>

    <div id="steps"></div>

    <script>
        const token = "{{TOKEN}}";

        async function init() {
            const res = await fetch("/api/verify/" + token);
            if (!res.ok) { document.getElementById("info").innerText = "Invalid or expired link."; return; }
            const meta = await res.json();
            document.getElementById("info").innerText = `Requested by ${meta.verifier_name || "Verifier"}. Please upload the following documents.`;
            const fields = meta.requested_fields && meta.requested_fields.length ? meta.requested_fields : ["aadhaar", "pan", "passport", "photo"];
            // Render each field with file input
            const cont = document.getElementById("steps");
            cont.innerHTML = "";
            fields.forEach((f, idx) => {
                const div = document.createElement("div");
                div.className = "card";
                div.id = "card_" + idx;
                div.innerHTML = `<strong>${f}</strong>
      <div class="muted">Tap Choose -> then Camera or Files. After selecting, press Upload for this field.</div>
      <input id="file_${idx}" type="file" accept="image/*,application/pdf" capture="environment">
      <div style="margin-top:8px"><button class="btn" onclick="uploadField('${f}', ${idx})">Upload ${f}</button></div>
      <div id="status_${idx}" class="muted" style="margin-top:8px"></div>
    `;
                cont.appendChild(div);
            });
            // final continue / refresh area
            const done = document.createElement("div");
            done.style.marginTop = "12px";
            done.innerHTML = `<button class="btn" onclick="finish()">Finish / Done</button>`;
            cont.appendChild(done);
        }

        async function uploadField(docType, idx) {
            const input = document.getElementById("file_" + idx);
            const status = document.getElementById("status_" + idx);
            if (!input.files || input.files.length === 0) { alert("Choose a file first"); return; }
            const file = input.files[0];
            // Build form
            const fd = new FormData();
            fd.append("doc_type", docType);
            fd.append("file", file);
            try {
                status.innerText = "Uploading...";
                const res = await fetch("/api/verify/" + token + "/upload", { method: "POST", body: fd });
                if (res.ok) {
                    const j = await res.json();
                    status.innerText = "Uploaded ✓ (id:" + j.doc_id + ")";
                    input.value = "";
                } else {
                    const err = await res.json();
                    status.innerText = "Error: " + (err.detail || JSON.stringify(err));
                    alert("Upload error: " + (err.detail || "Check file size/quality and try again"));
                }
            } catch (e) {
                status.innerText = "Network error";
            }
        }

        function finish() {
            alert("Thank you — upload finished. Close this page and inform verifier.");
        }

        init();
    </script>
</body>

</html>